---
title: Как работают запросы — EF Core
author: rowanmiller
ms.date: 10/27/2016
ms.assetid: de2e34cd-659b-4cab-b5ed-7a979c6bf120
uid: core/querying/overview
ms.openlocfilehash: f1c23471bfbc998b2d4f9dc579d1404d6202e109
ms.sourcegitcommit: dadee5905ada9ecdbae28363a682950383ce3e10
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/27/2018
ms.locfileid: "42993207"
---
# <a name="how-queries-work"></a>Как работают запросы

Entity Framework Core использует LINQ для запроса данных из базы данных. LINQ позволяет использовать C# (или предпочитаемый вами язык .NET) для написания строго типизированных запросов, основанных на производном контексте и классах сущностей.

## <a name="the-life-of-a-query"></a>Срок действия запроса

Ниже приведен общий обзор процесса, через который проходит каждый запрос.

1. LINQ-запрос обрабатывается Entity Framework Core для создания представления, которое готово для обработки поставщиком данных.
   1. Результат кэшируется, чтобы не выполнять эту обработку каждый раз при выполнении запроса.
2. Результат передается поставщику базы данных.
   1. Поставщик базы данных определяет, какие части запроса могут выполняться в базе данных.
   2. Эти части запроса преобразуются в язык запроса базы данных (например, SQL для реляционной базы данных).
   3. Один или несколько запросов отправляются в базу данных, и возвращается результирующий набор (результатами являются значения из базы данных, а не экземпляры сущностей).
3. Для каждого элемента в результирующем наборе выполняются следующие действия:
   1. Если это запрос отслеживания, EF проверяет, не предоставляют ли данные сущность, которая уже находится в объекте отслеживания изменений для экземпляра контекста.
      * Если да, возвращается имеющаяся сущность.
      * Если нет, создается другая сущность, устанавливается объект отслеживания изменений и возвращается новая сущность.
   2. Если это не запрос отслеживания, EF проверяет, не предоставляют ли данные сущность, которая уже находится в результирующем наборе для этого запроса.
      * Если да, возвращается имеющаяся сущность<sup>(1)</sup>.
      * Если нет, создается и возвращается другая сущность.

<sup>(1) </sup> В запросах, отличных от запросов отслеживания, используются слабые ссылки для отслеживания сущностей, которые уже были возвращены. Если предыдущий результат с тем же идентификатором выходит за пределы области, а сборка мусора выполняется, вы можете получить новый экземпляр сущности.

## <a name="when-queries-are-executed"></a>Когда выполняются запросы

При вызове операторов LINQ вы просто создаете представление запроса в памяти. Запрос отправляется в базу данных только после обработки результатов.

Ниже приведены наиболее распространенные операции, которые приводят к отправке запроса в базу данных.
* Итерация результатов в цикле `for`.
* Использование оператора, например `ToList`, `ToArray`, `Single`, `Count`.
* Привязка данных результатов запроса к пользовательскому интерфейсу.

> [!WARNING]  
> **Всегда проверяйте входные данные пользователя.** Так как EF предоставляет защиту от атак путем внедрения кода SQL, он не выполняет общую проверку входных данных. Поэтому если значения, передаваемые в API-интерфейсы, используемые в LINQ-запросах, назначенные свойствам сущности и т. д., поступают из непроверенного источника, необходимо выполнить проверку в соответствии с требованиями отдельного приложения. Сюда входят все входные данные пользователя, используемые для динамического формирования запросов. Даже при использовании LINQ, если вы принимаете входные данные пользователя для создания выражений, необходимо убедиться, что можно создать только предполагаемые выражения.
