---
title: Сложные типы - конструктор EF - EF6
author: divega
ms.date: 2016-10-23
ms.assetid: 9a8228ef-acfd-4575-860d-769d2c0e18a1
ms.openlocfilehash: d35504cbe60823249d54385962568802b3e41308
ms.sourcegitcommit: dadee5905ada9ecdbae28363a682950383ce3e10
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/27/2018
ms.locfileid: "42994857"
---
# <a name="complex-types---ef-designer"></a>Сложные типы - конструктор EF
В этом разделе показано, как сопоставить сложных типов с помощью Entity Framework Designer (конструктор EF) и как выполнять запросы для сущностей, которые содержат свойства сложного типа.

На следующем рисунке показана основные окна, которые используются при работе с конструктором EF.

![EFDesigner](~/ef6/media/efdesigner.png)

> [!NOTE]
> При создании концептуальной модели, предупреждения о несопоставленных сущностях и ассоциациях, появляются в списке ошибок. Эти предупреждения можно игнорировать, поскольку после нажатия кнопки для создания базы данных из модели, пропадут.

## <a name="what-is-a-complex-type"></a>Что такое сложный тип

Сложные типы — это нескалярные свойства типов сущности, которые позволяют организовать в сущностях скалярные свойства. Подобно сущностям, сложные типы состоят из скалярных свойств или свойств других сложных типов.

При работе с объектами, представляющими сложные типы, следует учитывать следующее:

-   Сложные типы не имеют ключей и поэтому не могут существовать независимо друг от друга. Сложные типы могут существовать только как свойства типов сущностей или других сложных типов.
-   Сложные типы не могут участвовать в ассоциации и не может содержать свойства навигации.
-   Свойства сложного типа не может быть **null**. ** InvalidOperationException ** возникает, когда **DbContext.SaveChanges** вызывается и обнаруживается неопределенный сложный объект. Скалярные свойства сложных объектов могут принимать **null**.
-   Сложные типы не могут наследоваться от других сложных типов.
-   Необходимо определить сложный тип как **класс**. 
-   EF определяет изменения в члены на объект сложного типа при **DbContext.DetectChanges** вызывается. Платформа Entity Framework вызывает **DetectChanges** автоматически, когда вызываются следующие члены: **DbSet.Find**, **DbSet.Local**, **DbSet.Remove**, **DbSet.Add**, **DbSet.Attach**, **DbContext.SaveChanges**, **DbContext.GetValidationErrors**, **DbContext.Entry**, **DbChangeTracker.Entries**.

## <a name="refactor-an-entitys-properties-into-new-complex-type"></a>Оптимизация свойств сущности в новый сложный тип

При наличии сущности в концептуальной модели может потребоваться реструктурировать некоторые свойства в свойство сложного типа.

В рабочей области конструктора, выберите один или несколько свойств (кроме свойств навигации) сущность, затем щелкните правой кнопкой мыши и выберите **рефакторинг -&gt; переместить в новый сложный тип**.

![Рефакторинг](~/ef6/media/refactor.png)

Добавляется новый сложный тип с выбранными свойствами **браузер моделей**. Сложному типу присваивается имя по умолчанию.

Сложное свойство только что созданного типа заменит выбранные свойства. Все сопоставления свойств будут сохранены.

![Refactor2](~/ef6/media/refactor2.png)

## <a name="create-a-new-complex-type"></a>Создать новый сложный тип

Можно также создать новый сложный тип, который не содержит свойства существующей сущности.

Щелкните правой кнопкой мыши **сложные типы** папки в браузере моделей, пункты **AddNew сложный тип...** . Кроме того, можно выбрать **сложные типы** папку и нажмите клавишу **вставить** на клавиатуре.

![AddNewComplextype](~/ef6/media/addnewcomplextype.png)

Новый сложный тип будет добавлен в папку с именем по умолчанию. Теперь можно добавить свойства к типу.

## <a name="add-properties-to-a-complex-type"></a>Добавлять свойства к сложному типу

Свойства сложного типа могут иметь как скалярные, так и существующие сложные типы. Однако свойства сложного типа не могут иметь циклических ссылок. Например, сложный тип **OnsiteCourseDetails** свойство сложного типа не может быть **OnsiteCourseDetails**.

Добавить свойство к сложному типу можно любым из следующих способов.

-   Щелкните правой кнопкой мыши сложный тип в браузере моделей, выберите пункт **добавить**, наведите указатель на **скалярное свойство** или **сложное свойство**, затем выберите необходимый тип свойства. Кроме того, можно выбрать сложный тип и нажмите клавишу **вставить** на клавиатуре.  

    ![AddPropertiestoComplexType](~/ef6/media/addpropertiestocomplextype.png)

    Новое свойство будет добавлено к сложному типу с именем по умолчанию.

- OR-

-   Щелкните правой кнопкой мыши свойство сущности **конструктор EF** и выберите пункт **копирования**, щелкните правой кнопкой мыши сложный тип в **браузер моделей** и выберите  **Вставить**.

## <a name="rename-a-complex-type"></a>Переименование сложного типа

При переименовании сложного типа все ссылки на тип обновляются по всему проекту.

-   Дважды щелкните сложный тип в **браузер моделей**.
    Имя будет выбрано в режиме редактирования.

- OR-

-   Щелкните правой кнопкой мыши сложный тип в **браузер моделей** и выберите **Переименовать**.

- OR-

-   Выберите сложный тип в браузере моделей и нажмите клавишу F2.

- OR-

-   Щелкните правой кнопкой мыши сложный тип в **браузер моделей** и выберите **свойства**. Измените имя в **свойства** окна.

## <a name="add-an-existing-complex-type-to-an-entity-and-map-its-properties-to-table-columns"></a>Добавление существующего сложного типа к сущности и сопоставить ее свойства со столбцами таблицы

1.  Щелкните правой кнопкой мыши сущность, выберите пункт **Add New**и выберите **сложное свойство**.
    Свойство сложного типа с именем по умолчанию будет добавлено к сущности. Свойству назначается тип по умолчанию (выбранный из имеющихся сложных типов).
2.  Назначьте свойству в требуемый тип **свойства** окна.
    После добавления свойства сложного типа к сущности необходимо сопоставить ее свойства со столбцами таблицы.
3.  Щелкните правой кнопкой мыши тип сущности в области конструктора или в **браузер моделей** и выберите **сопоставления таблиц**.
    Сопоставления таблицы отображаются в **сведения о сопоставлении** окна.
4.  Разверните **сопоставляется &lt;имя таблицы&gt;**  узла.
    Объект **сопоставления столбцов** появится узел.
5.  Разверните **сопоставления столбцов** узла.
    Появится список всех столбцов таблицы. Свойства по умолчанию (если таковые имеются) с которыми сопоставляются столбцы отображаются в категории **значение/свойство** заголовок.
6.  Выберите столбец, необходимо сопоставить и щелкните правой кнопкой мыши соответствующий **значение/свойство** поля.
    Отобразится раскрывающийся список всех скалярных свойств.
7.  Выберите соответствующее свойство.

    ![MapComplexType](~/ef6/media/mapcomplextype.png)

8.  Повторите шаги 6 и 7 для каждого столбца таблицы.

>[!NOTE]
> Чтобы удалить сопоставление столбцов, выберите столбец, который необходимо сопоставить, а затем нажмите кнопку **значение/свойство** поля. Выберите **удалить** из раскрывающегося списка.

## <a name="map-a-function-import-to-a-complex-type"></a>Сопоставить импорт функции со сложным типом

Импорт функций основан на хранимых процедурах. Чтобы сопоставить импорт со сложным типом, столбцы, возвращаемые соответствующей хранимой процедурой, должны соответствовать свойствам сложного типа по числу и должны иметь типы хранения, совместимые с типами свойств.

-   Дважды щелкните импортированной функции, которую необходимо сопоставить со сложным типом.

    ![FunctionImports](~/ef6/media/functionimports.png)

-   Задайте параметры для нового импорта функции следующим образом.
    -   Укажите хранимую процедуру, для которой создается импорт функции в **имя хранимой процедуры** поля. Это поле представляет собой раскрывающийся список, содержащий все хранимые процедуры, которые имеются в модели хранения.
    -   Укажите имя импорта функции в **имя импорта функции** поля.
    -   Выберите **сложных** как возвращаемый тип, а затем укажите конкретный сложный возвращаемый тип, выбрав соответствующий тип из раскрывающегося списка.

        ![EditFunctionImport](~/ef6/media/editfunctionimport.png)

-   Нажмите кнопку **ОК**.
    В концептуальной модели создается запись импорта функции.

### <a name="customize-column-mapping-for-function-import"></a>Настроить сопоставление для импорта функции столбцов

-   Щелкните правой кнопкой мыши импорт функции в браузере моделей и выберите **сопоставление импорта функций**.
    **Сведения о сопоставлении** окно отобразится сопоставление по умолчанию для импорта функции. Стрелки указывают сопоставления между значениями столбцов и значениями свойств. По умолчанию предполагается, что имена столбцов совпадают с именами свойств сложного типа. Имена столбцов по умолчанию отображаются серым текстом.
-   Если необходимо, измените имена столбцов таким образом, чтобы они совпадали с именами столбцов, возвращаемых хранимой процедурой, соответствующей импорту функции.

## <a name="delete-a-complex-type"></a>Удаление сложного типа

При удалении сложного типа он удаляется из концептуальной модели. Кроме того, удаляются сопоставления для всех экземпляров типа. Однако ссылки на тип не обновляются. Например, если сущность имеет свойство сложного типа типа ComplexType1, и ComplexType1 был удален в **браузер моделей**, то соответствующее свойство сущности не обновляется. Модель не пройдет проверку, так как он содержит сущность, которая ссылается на удаленный сложный тип. Обновить или удалить ссылки на удаленные сложные типы можно с помощью конструктора сущностей.

-   Щелкните правой кнопкой мыши сложный тип в браузере моделей и выберите **удалить**.

- OR-

-   В браузере моделей выберите сложный тип и нажмите на клавиатуре клавишу DELETE.

## <a name="query-for-entities-containing-properties-of-complex-type"></a>Запрос для сущностей, содержащий свойства сложного типа

Ниже показано, как выполнить запрос, возвращающий коллекцию сущностей типа объектов, содержащих свойства сложного типа.

``` csharp
    using (SchoolEntities context = new SchoolEntities())
    {
        var courses =
            from c in context.OnsiteCourses
            order by c.Details.Time
            select c;

        foreach (var c in courses)
        {
            Console.WriteLine("Time: " + c.Details.Time);
            Console.WriteLine("Days: " + c.Details.Days);
            Console.WriteLine("Location: " + c.Details.Location);
        }
    }
```
