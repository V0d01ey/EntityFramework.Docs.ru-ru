---
title: Быстрый запуск с помощью NGen - EF6
author: divega
ms.date: 2016-10-23
ms.prod: entity-framework
ms.author: divega
ms.manager: avickers
ms.technology: entity-framework-6
ms.topic: article
ms.assetid: dc6110a0-80a0-4370-8190-cea942841cee
caps.latest.revision: 4
ms.openlocfilehash: cffd2deea3148a16ed704d1e5e7b365eda06f72b
ms.sourcegitcommit: bdd06c9a591ba5e6d6a3ec046c80de98f598f3f3
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/10/2018
ms.locfileid: "39122737"
---
# <a name="improving-startup-performance-with-ngen"></a><span data-ttu-id="11ec1-102">Быстрый запуск с помощью NGen</span><span class="sxs-lookup"><span data-stu-id="11ec1-102">Improving startup performance with NGen</span></span>
> [!NOTE]
> <span data-ttu-id="11ec1-103">**Только в EF6 и более поздних версиях**. Функции, API и другие возможности, описанные на этой странице, появились в Entity Framework 6.</span><span class="sxs-lookup"><span data-stu-id="11ec1-103">**EF6 Onwards Only** - The features, APIs, etc. discussed in this page were introduced in Entity Framework 6.</span></span> <span data-ttu-id="11ec1-104">При использовании более ранней версии могут быть неприменимы некоторые или все сведения.</span><span class="sxs-lookup"><span data-stu-id="11ec1-104">If you are using an earlier version, some or all of the information does not apply.</span></span>  

<span data-ttu-id="11ec1-105">Платформа .NET Framework поддерживает создание образов в машинном коде для управляемых приложений и библиотек, как способ защиты приложения запускаются быстрее, а также в некоторых случаях использовать меньше памяти.</span><span class="sxs-lookup"><span data-stu-id="11ec1-105">The .NET Framework supports the generation of native images for managed applications and libraries as a way to help applications start faster and also in some cases use less memory.</span></span> <span data-ttu-id="11ec1-106">Образы в машинном коде создаются путем перевода сборки с управляемым кодом в файлы, содержащие инструкции машинного перед выполнением приложения, освобождая разработчика компилятор .NET JIT (Just-In-Time) от необходимости создания собственного инструкциям, приведенным в Среда выполнения приложения.</span><span class="sxs-lookup"><span data-stu-id="11ec1-106">Native images are created by translating managed code assemblies into files containing native machine instructions before the application is executed, relieving the .NET JIT (Just-In-Time) compiler from having to generate the native instructions at application runtime.</span></span>  

<span data-ttu-id="11ec1-107">До версии 6 библиотеки среды выполнения EF core были частью .NET Framework и образы в машинном коде были автоматически созданы для них.</span><span class="sxs-lookup"><span data-stu-id="11ec1-107">Prior to version 6, the EF runtime’s core libraries were part of the .NET Framework and native images were generated automatically for them.</span></span> <span data-ttu-id="11ec1-108">Начиная с версии 6 всей среды выполнения EF объединены в пакет EntityFramework NuGet.</span><span class="sxs-lookup"><span data-stu-id="11ec1-108">Starting with version 6 the whole EF runtime has been combined into the EntityFramework NuGet package.</span></span> <span data-ttu-id="11ec1-109">Образы в машинном коде для теперь быть созданы с помощью средства командной строки NGen.exe для получения результатов похожих.</span><span class="sxs-lookup"><span data-stu-id="11ec1-109">Native images have to now be generated using the NGen.exe command line tool to obtain similar results.</span></span>  

<span data-ttu-id="11ec1-110">Эмпирическим наблюдениям показывают, что образы в машинном коде для сборки среды выполнения EF можно вырезать от 1 до 3 секунд времени запуска приложения.</span><span class="sxs-lookup"><span data-stu-id="11ec1-110">Empirical observations show that native images of the EF runtime assemblies can cut between 1 and 3 seconds of application startup time.</span></span>  

## <a name="how-to-use-ngenexe"></a><span data-ttu-id="11ec1-111">Как использовать NGen.exe</span><span class="sxs-lookup"><span data-stu-id="11ec1-111">How to use NGen.exe</span></span>  

<span data-ttu-id="11ec1-112">Основная функция средством NGen.exe — «установка» (то есть для создания и сохранения на диск) образов в машинном коде для сборки и всех его прямых зависимостей.</span><span class="sxs-lookup"><span data-stu-id="11ec1-112">The most basic function of the NGen.exe tool is to “install” (that is, to create and persist to disk) native images for an assembly and all its direct dependencies.</span></span> <span data-ttu-id="11ec1-113">Вот, как это можно сделать:</span><span class="sxs-lookup"><span data-stu-id="11ec1-113">Here is how you can achieve that:</span></span>  

1. <span data-ttu-id="11ec1-114">Откройте окно командной строки с правами администратора</span><span class="sxs-lookup"><span data-stu-id="11ec1-114">Open a Command Prompt window as an administrator</span></span>  
2. <span data-ttu-id="11ec1-115">Измените расположение сборок, которые требуется создать образы в машинном коде для текущего рабочего каталога:</span><span class="sxs-lookup"><span data-stu-id="11ec1-115">Change the current working directory to the location of the assemblies you want to generate native images for:</span></span>  

  ``` console
    cd <*Assemblies location*>  
  ```
3. <span data-ttu-id="11ec1-116">В зависимости от операционной системы и конфигурации для приложения может потребоваться для создания образов в машинном коде для 32-разрядной архитектуры, 64-разрядной архитектуры или одновременно обеих платформ.</span><span class="sxs-lookup"><span data-stu-id="11ec1-116">Depending on your operating system and the application’s configuration you might need to generate native images for 32 bit architecture, 64 bit architecture or for both.</span></span>  

    <span data-ttu-id="11ec1-117">Для запуска 32-разрядная версия:</span><span class="sxs-lookup"><span data-stu-id="11ec1-117">For 32 bit run:</span></span>  
  ``` console
    %WINDIR%\Microsoft.NET\Framework\v4.0.30319\ngen install <Assembly name>  
  ```
    <span data-ttu-id="11ec1-118">Для 64-разрядных запуска:</span><span class="sxs-lookup"><span data-stu-id="11ec1-118">For 64 bit run:</span></span>
  ``` console
    %WINDIR%\Microsoft.NET\Framework64\v4.0.30319\ngen install <Assembly name>  
  ```

> [!TIP]
> <span data-ttu-id="11ec1-119">Создание образов в машинном коде для неправильной архитектурой является распространенной ошибкой.</span><span class="sxs-lookup"><span data-stu-id="11ec1-119">Generating native images for the wrong architecture is a very common mistake.</span></span> <span data-ttu-id="11ec1-120">Если сомневаетесь, можно просто создать образы в машинном коде для всех архитектур, которые применяются к операционной системы, установленной на компьютере.</span><span class="sxs-lookup"><span data-stu-id="11ec1-120">When in doubt you can simply generate native images for all the architectures that apply to the operating system installed in the machine.</span></span>  

<span data-ttu-id="11ec1-121">NGen.exe также поддерживает другие функции, такие как удаление и Отображение установленных образов в машинном коде, очереди создания нескольких образов и т. д. Дополнительные сведения об использовании. в статье [документации NGen.exe](https://msdn.microsoft.com/library/6t9t5wcf.aspx).</span><span class="sxs-lookup"><span data-stu-id="11ec1-121">NGen.exe also supports other functions such as uninstalling and displaying the installed native images, queuing the generation of multiple images, etc. For more details of usage read the [NGen.exe documentation](https://msdn.microsoft.com/library/6t9t5wcf.aspx).</span></span>  

## <a name="when-to-use-ngenexe"></a><span data-ttu-id="11ec1-122">Когда следует использовать NGen.exe</span><span class="sxs-lookup"><span data-stu-id="11ec1-122">When to use NGen.exe</span></span>  

<span data-ttu-id="11ec1-123">Когда дело доходит до решить, какие сборки для создания образов в машинном коде для в приложении, в зависимости от EF 6 или более поздней версии, учитывайте следующие параметры.</span><span class="sxs-lookup"><span data-stu-id="11ec1-123">When it comes to decide which assemblies to generate native images for in an application based on EF version 6 or greater, you should consider the following options:</span></span>  

- <span data-ttu-id="11ec1-124">**Основной сборки среды выполнения EF, EntityFramework.dll**: типичного приложения на основе EF выполняет значительный объем кода из этой сборки, при запуске или при его первом доступе к базе данных.</span><span class="sxs-lookup"><span data-stu-id="11ec1-124">**The main EF runtime assembly, EntityFramework.dll**: A typical EF based application executes a significant amount of code from this assembly on startup or on its first access to the database.</span></span> <span data-ttu-id="11ec1-125">Следовательно создание образов в машинном коде для этой сборки приведет крупнейших выигрыш в производительности при запуске.</span><span class="sxs-lookup"><span data-stu-id="11ec1-125">Consequently, creating native images of this assembly will produce the biggest gains in startup performance.</span></span>  
- <span data-ttu-id="11ec1-126">**Любой сборки поставщика EF, используемой приложением**: время запуска также могут немного выиграть от генерации машинных образов из них.</span><span class="sxs-lookup"><span data-stu-id="11ec1-126">**Any EF provider assembly used by your application**: Startup time can also benefit slightly from generating native images of these.</span></span> <span data-ttu-id="11ec1-127">Например если приложение использует поставщика EF для SQL Server требуется создать образ в машинном коде для EntityFramework.SqlServer.dll.</span><span class="sxs-lookup"><span data-stu-id="11ec1-127">For example, if the application uses the EF provider for SQL Server you will want to generate a native image for EntityFramework.SqlServer.dll.</span></span>  
- <span data-ttu-id="11ec1-128">**Сборок приложения и другие зависимости**: [документации NGen.exe](https://msdn.microsoft.com/library/6t9t5wcf.aspx) рассматриваются общие критерии для выбора сборки для создания образов в машинном коде и влияние образов в машинном коде на безопасности, Дополнительные параметры, такие как «жесткая привязка», сценарии, как использование образов в машинном коде в отладки и профилирования, сценарии и т. д.</span><span class="sxs-lookup"><span data-stu-id="11ec1-128">**Your application’s assemblies and other dependencies**: The [NGen.exe documentation](https://msdn.microsoft.com/library/6t9t5wcf.aspx) covers general criteria for choosing which assemblies to generate native images for and the impact of native images on security, advanced options such as “hard binding”, scenarios such as using native images in debugging and profiling scenarios, etc.</span></span>  

> [!TIP]
> <span data-ttu-id="11ec1-129">Убедитесь в том, что вы тщательно оценить влияние использования образов в машинном коде на производительность при запуске и общую производительность приложения и сравните их с фактические требования.</span><span class="sxs-lookup"><span data-stu-id="11ec1-129">Make sure you carefully measure the impact of using native images on both the startup performance and the overall performance of your application and compare them against actual requirements.</span></span> <span data-ttu-id="11ec1-130">Образы в машинном коде обычно помогает повысить запуска показатель производительности и в некоторых случаях снизить использование памяти, столь же отразится не для всех сценариев.</span><span class="sxs-lookup"><span data-stu-id="11ec1-130">While native images will generally help improve startup up performance and in some cases reduce memory usage, not all scenarios will benefit equally.</span></span> <span data-ttu-id="11ec1-131">К примеру в устойчивом состоянии выполнения (то есть после хотя бы один раз после вызова всех методов, которые используются приложением) код, сгенерированный JIT-компилятор может фактически дать немного лучшую производительность, чем образы в машинном коде.</span><span class="sxs-lookup"><span data-stu-id="11ec1-131">For instance, on steady state execution (that is, once all the methods being used by the application have been invoked at least once) code generated by the JIT compiler can in fact yield slightly better performance than native images.</span></span>  

## <a name="using-ngenexe-in-a-development-machine"></a><span data-ttu-id="11ec1-132">С помощью NGen.exe на машине разработки</span><span class="sxs-lookup"><span data-stu-id="11ec1-132">Using NGen.exe in a development machine</span></span>  

<span data-ttu-id="11ec1-133">Во время разработки .NET JIT компилятора предложит установить общую наилучшего для кода, который часто изменяется.</span><span class="sxs-lookup"><span data-stu-id="11ec1-133">During development the .NET JIT compiler will offer the best overall tradeoff for code that is changing frequently.</span></span> <span data-ttu-id="11ec1-134">Создание образов в машинном коде для скомпилированного зависимости, такие как сборки среды выполнения EF может помочь ускорить процесс разработки и тестирования, вырезание несколько секунд в начале каждого выполнения.</span><span class="sxs-lookup"><span data-stu-id="11ec1-134">Generating native images for compiled dependencies such as the EF runtime assemblies can help accelerate development and testing by cutting a few seconds out at the beginning of each execution.</span></span>  

<span data-ttu-id="11ec1-135">Отлично подходит для поиска сборки среды выполнения EF является расположение пакета NuGet для решения.</span><span class="sxs-lookup"><span data-stu-id="11ec1-135">A good place to find the EF runtime assemblies is the NuGet package location for the solution.</span></span> <span data-ttu-id="11ec1-136">Например, для приложения с помощью EF 6.0.2 с SQL Server и предназначенных для .NET 4.5 или более поздней можно ввести следующее в окне командной строки (не забудьте открыть его в качестве администратора):</span><span class="sxs-lookup"><span data-stu-id="11ec1-136">For example, for an application using EF 6.0.2 with SQL Server and targeting .NET 4.5 or greater you can type the following in a Command Prompt window (remember to open it as an administrator):</span></span>  

``` console
cd <Solution directory>\packages\EntityFramework.6.0.2\lib\net45
%WINDIR%\Microsoft.NET\Framework\v4.0.30319\ngen install EntityFramework.SqlServer.dll
%WINDIR%\Microsoft.NET\Framework64\v4.0.30319\ngen install EntityFramework.SqlServer.dll
```  

> [!NOTE]
> <span data-ttu-id="11ec1-137">Это позволяет пользоваться преимуществами тот факт, что установка образы в машинном коде для поставщика EF для SQL Server также по умолчанию установит образы в машинном коде для основной сборки среды выполнения EF.</span><span class="sxs-lookup"><span data-stu-id="11ec1-137">This takes advantage of the fact that installing the native images for EF provider for SQL Server will also by default install the native images for the main EF runtime assembly.</span></span> <span data-ttu-id="11ec1-138">Это работает, поскольку NGen.exe можно определить, что EntityFramework.dll прямых зависимостей сборки EntityFramework.SqlServer.dll, расположенной в том же каталоге.</span><span class="sxs-lookup"><span data-stu-id="11ec1-138">This works because NGen.exe can detect that EntityFramework.dll is a direct dependency of the EntityFramework.SqlServer.dll assembly located in the same directory.</span></span>  

## <a name="creating-native-images-during-setup"></a><span data-ttu-id="11ec1-139">Создание образов в машинном коде во время установки</span><span class="sxs-lookup"><span data-stu-id="11ec1-139">Creating native images during setup</span></span>  

<span data-ttu-id="11ec1-140">Набор средств WiX поддерживает очереди создание образов в машинном коде для управляемых сборок во время установки, описанные в этой [практическом руководстве](http://wixtoolset.org/documentation/manual/v3/howtos/files_and_registry/ngen_managed_assemblies.html).</span><span class="sxs-lookup"><span data-stu-id="11ec1-140">The WiX Toolkit supports queuing the generation of native images for managed assemblies during setup, as explained in this [how-to guide](http://wixtoolset.org/documentation/manual/v3/howtos/files_and_registry/ngen_managed_assemblies.html).</span></span> <span data-ttu-id="11ec1-141">Другой вариант — Создать задачу пользовательской установки, воспользуйтесь командой NGen.exe.</span><span class="sxs-lookup"><span data-stu-id="11ec1-141">Another alternative is to create a custom setup task that execute the NGen.exe command.</span></span>  

## <a name="verifying-that-native-images-are-being-used-for-ef"></a><span data-ttu-id="11ec1-142">Проверка того, что образы в машинном коде используются для Entity FRAMEWORK</span><span class="sxs-lookup"><span data-stu-id="11ec1-142">Verifying that native images are being used for EF</span></span>  

<span data-ttu-id="11ec1-143">Убедитесь, что определенное приложение использует машинные сборки для загружаемых сборок, которые имеют расширение «. ni.dll «или». ni.exe».</span><span class="sxs-lookup"><span data-stu-id="11ec1-143">You can verify that a specific application is using a native assembly by looking for loaded assemblies that have the extension “.ni.dll” or “.ni.exe”.</span></span> <span data-ttu-id="11ec1-144">Например образ в машинном коде для сборки основной среды выполнения EF будет вызываться EntityFramework.ni.dll.</span><span class="sxs-lookup"><span data-stu-id="11ec1-144">For example, a native image for the EF’s main runtime assembly will be called EntityFramework.ni.dll.</span></span> <span data-ttu-id="11ec1-145">Простой способ проверки загруженных сборок .NET процесса является использование [Process Explorer](https://technet.microsoft.com/sysinternals/bb896653).</span><span class="sxs-lookup"><span data-stu-id="11ec1-145">An easy way to inspect the loaded .NET assemblies of a process is to use [Process Explorer](https://technet.microsoft.com/sysinternals/bb896653).</span></span>  

## <a name="other-things-to-be-aware-of"></a><span data-ttu-id="11ec1-146">Следует учитывать следующие моменты</span><span class="sxs-lookup"><span data-stu-id="11ec1-146">Other things to be aware of</span></span>  

<span data-ttu-id="11ec1-147">**Создание образа в машинном коде сборки не следует путать с регистрации сборки в [GAC (глобальный кэш сборок)](https://msdn.microsoft.com/library/yf1d93sz.aspx)**.</span><span class="sxs-lookup"><span data-stu-id="11ec1-147">**Creating a native image of an assembly should not be confused with registering the assembly in the [GAC (Global Assembly Cache)](https://msdn.microsoft.com/library/yf1d93sz.aspx)**.</span></span> <span data-ttu-id="11ec1-148">NGen.exe позволяет создавать образы сборок, которые не находятся в глобальном кэше СБОРОК, а на самом деле, несколько приложений, использующих определенную версию EF могут совместно использовать же образа в машинном коде.</span><span class="sxs-lookup"><span data-stu-id="11ec1-148">NGen.exe allows creating images of assemblies that are not in the GAC, and in fact, multiple applications that use a specific version of EF can share the same native image.</span></span> <span data-ttu-id="11ec1-149">Хотя Windows 8 может автоматически создавать образы в машинном коде для сборок, помещенных в глобальный кэш СБОРОК, исполняющая среда EF оптимизирован для развертывания вместе с приложения, и мы не рекомендуем его регистрация в глобальном кэше СБОРОК, как это негативно влияет на разрешения сборки и обслуживание приложений среди других аспектах.</span><span class="sxs-lookup"><span data-stu-id="11ec1-149">While Windows 8 can automatically create native images for assemblies placed in the GAC, the EF runtime is optimized to be deployed alongside your application and we do not recommend registering it in the GAC as this has a negative impact on assembly resolution and servicing your applications among other aspects.</span></span>  
