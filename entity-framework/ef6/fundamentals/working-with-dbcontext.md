---
title: Работа с DbContext - EF6
author: divega
ms.date: 2016-10-23
ms.prod: entity-framework
ms.author: divega
ms.manager: avickers
ms.technology: entity-framework-6
ms.topic: article
ms.assetid: b0e6bddc-8a87-4d51-b1cb-7756df938c23
caps.latest.revision: 3
ms.openlocfilehash: 865c9883ce25f405a173791df4e46b98550cd41f
ms.sourcegitcommit: f05e7b62584cf228f17390bb086a61d505712e1b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/08/2018
ms.locfileid: "39121857"
---
# <a name="working-with-dbcontext"></a>Работа с DbContext

Чтобы использовать Entity Framework для запроса, вставки, обновления и удаления данных, используя объекты .NET, необходимо сначала [создать модель](~/ef6/modeling/index.md) который сопоставляет сущности и связи, которые определены в модели с таблицами в базе данных.

При наличии модели является основным классом, ваше приложение взаимодействует с `System.Data.Entity.DbContext` (часто обозначается как класс контекста). Можно использовать связанные модели для DbContext:
- Запись и выполнение запросов   
- Материализовать результаты запроса в форме объектов сущности
- Отслеживать изменения, внесенные в эти объекты
- Сохранить изменения объектов обратно в базе данных
- Привязка объектов в памяти к элементам управления пользовательского интерфейса

На этой странице приведены некоторые рекомендации по управлению класс контекста.  

## <a name="defining-a-dbcontext-derived-class"></a>Определение класса, производного DbContext  

Для работы с контекстом рекомендуется определить класс, производный от DbContext и обеспечивает доступ к свойствам DbSet, представляющие коллекцию сущностей, указанный в контексте. При работе с конструктором, EF, контекст будет создаваться автоматически. Если вы работаете в режиме Code First, будут обычно контексте самостоятельном написании.  

``` csharp
public class ProductContext : DbContext
{
    public DbSet<Category> Categories { get; set; }
    public DbSet<Product> Products { get; set; }
}
```  

Получив контекст, нужно запросить, добавить (с помощью `Add` или `Attach` методы) или удалить (с помощью `Remove`) сущностей в контексте через эти свойства. Доступ к `DbSet` свойство в объекте контекста представляет начальный запрос, возвращающий все сущности заданного типа. Обратите внимание на то, что только доступ к свойству не будет выполняться запрос. Запрос выполняется при:  

- Запрос перечисляется с помощью инструкции `foreach` (C#) или `For Each` (Visual Basic).  
- Запрос перечисляется операцией коллекции, такие как `ToArray`, `ToDictionary`, или `ToList`.  
- Операторы LINQ, такие как `First` или `Any` указываются в внешней части запроса.  
- Вызван один из следующих методов: `Load` метод расширения, `DbEntityEntry.Reload`, `Database.ExecuteSqlCommand`, и `DbSet<T>.Find`, если сущность с указанным ключом отсутствует уже загружены в контекст.  

## <a name="lifetime"></a>Время существования  

Время существования контекста начинается, когда создается экземпляр и заканчивается, когда экземпляр удаляется или сборщиком мусора. Используйте **с помощью** Если необходимо, чтобы все ресурсы, контекст управляет непосредственно перед удалением в конце блока. При использовании **с помощью**, компилятор автоматически создает блок try/finally и вызывает удаление в **наконец** блока.  

``` csharp
public void UseProducts()
{
    using (var context = new ProductContext())
    {     
        // Perform data access using the context
    }
}
```  

Ниже приведены некоторые общие рекомендации при принятии решения о времени существования контекста.  

- При работе с веб-приложений, используйте экземпляр контекста каждого запроса.  
- При работе с Windows Presentation Foundation (WPF) или Windows Forms, используйте экземпляр контекста на каждую форму. Это позволяет использовать функции отслеживания изменений предоставляет этот контекст.  
- Если создан экземпляр контекста с контейнер внедрения зависимостей, он отвечает обычно контейнера высвобождение контекста.
- Если контекст создается в коде приложения, не забывайте удалять контекст, когда он больше не требуется.  
- При работе с длительно существующем контексте учитывайте следующее:  
    - Несколько объектов и их ссылок при загрузке в память, может быстро увеличить потребление памяти контекста. Это может вызвать снижение производительности.  
    - Контекст не является потокобезопасным, поэтому его не следует использовать совместно в нескольких потоках одновременно выполняют его работу.
    - Если исключение вызывает контекст быть в состоянии неустранимых, всего приложения может завершиться.  
    - Вероятность возникновения проблем с параллелизмом возрастает по мере увеличения разрыва между временем запроса и временем обновления данных.  

## <a name="connections"></a>Подключения  

По умолчанию контекст управляет подключениями к базе данных. Контекст открывает и закрывает соединения по мере необходимости. Например контекст открывает соединение для выполнения запроса и затем закрывает соединение, когда будут обработаны все результирующие наборы.  

В некоторых случаях необходимо больше контроля над открытием и закрытием соединения. Например при работе с SQL Server Compact, часто рекомендуется поддерживать отдельные откройте подключение к базе данных в течение времени существования приложения для повышения производительности. Процессом можно управлять вручную с помощью свойства `Connection`.  
